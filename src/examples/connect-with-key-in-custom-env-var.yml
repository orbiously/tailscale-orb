description: >
  Connect to Tailscale using an auth key stored in a custom-named environment variable and send a file to the remote Tailscale host via Taildrop
usage:
  version: 2.1

  orbs:
    tailscale: orbiously/tailscale@1.0.0

  jobs:
    one-amazing-job:
      docker:
        - image: cimg/base:2022.08
      resource_class: small

      steps:
        - tailscale/install

        - tailscale/connect:
            ts-dst-host: "100.121.112.23"
            ts-auth-key: MY_TS_KEY

        - run:
            name: Sending a file via Tailscale
            command: |
              echo "I <3 CircleCI" > my_file.txt

              ### Now let's send the file using the `tailscale file` subcommand of the Tailscale CLI
              ### (https://tailscale.com/kb/1106/taildrop/#sending-files-with-taildrop).

              tailscale --socket=/tmp/tailscaled.sock file cp my_file.txt 100.121.112.23:

              ### In the above command, the `--socket=/tmp/tailscaled.sock` flag is needed because to run Tailscale on Docker we leverage the userspace networking mode
              ### (https://tailscale.com/kb/1112/userspace-networking/)
              ### The `connect` command of the orb starts the `tailscaled` daemon with that specific socket (/tmp/tailscaled.sock).
              ### Due to permission restrictions we can't use the default socket location (/var/run/tailscale/tailscaled.sock)

              echo "I bet there's now a file named `my_file.txt` stored on the host with Tailscale IP `100.121.112.23`"

        - tailscale/disconnect
workflows:
  use-my-orb:
    jobs:
      - one-amazing-job
